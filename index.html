<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GPU ASCII CAM</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; font-family: monospace; }
        canvas { width: 100vw; height: auto; image-rendering: pixelated; }
        .ui { position: fixed; bottom: 20px; background: rgba(0,0,0,0.8); color: #0f0; padding: 15px; border-radius: 20px; z-index: 10; text-align: center; }
        button { background: #222; color: #0f0; border: 1px solid #0f0; padding: 10px 20px; border-radius: 10px; margin-top: 10px; }
    </style>
</head>
<body>

    <canvas id="output"></canvas>
    
    <div class="ui">
        <div>Resolution: 400 x 300</div>
        <button id="flip">Switch Camera</button>
    </div>

    <script type="module">
        // Using a tiny library for WebGL ASCII to ensure 400x300 works on mobile
        import { AsciiEffect } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/effects/AsciiEffect.js';
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';

        const flipBtn = document.getElementById('flip');
        let currentFacingMode = "environment";
        let scene, camera, renderer, effect, video, texture;

        async function init() {
            // 1. Setup Video
            video = document.createElement('video');
            video.autoplay = true;
            video.playsInline = true;
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: currentFacingMode } 
                });
                video.srcObject = stream;
                video.play();
            } catch (e) { alert("Camera Error: " + e.message); }

            // 2. Setup Three.js Scene
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, 400/300, 0.1, 1000);
            camera.position.z = 5;

            renderer = new THREE.WebGLRenderer({ antialias: false });
            renderer.setSize(400, 300);

            // 3. Create ASCII Effect (Characters: $@B%8&WM#*oahkbdpqwmZO0QLCJUYXzcvunxrjft/\|()1{}[]?-_+~<>i!lI;:,"^`'. )
            effect = new AsciiEffect(renderer, ' .:-=+*#%@', { invert: true, color: true });
            effect.setSize(window.innerWidth, window.innerHeight);
            document.body.replaceChild(effect.domElement, document.getElementById('output'));

            // 4. Video Texture
            texture = new THREE.VideoTexture(video);
            const geometry = new THREE.PlaneGeometry(16, 12);
            const material = new THREE.MeshBasicMaterial({ map: texture });
            const mesh = new THREE.Mesh(geometry, material);
            
            // Mirroring logic
            if (currentFacingMode === "user") mesh.scale.x = -1;
            
            scene.add(mesh);

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            effect.render(scene, camera);
        }

        flipBtn.onclick = () => {
            currentFacingMode = currentFacingMode === "environment" ? "user" : "environment";
            location.reload(); // Quickest way to reset the stream and flip
        };

        window.onresize = () => effect.setSize(window.innerWidth, window.innerHeight);

        init();
    </script>
</body>
</html>

